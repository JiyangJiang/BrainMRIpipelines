Generating T1 map with qMRLab
==============================

Registering B1 ref/map to MP2RAGE UNI
-------------------------------------
..  code-block::

	# registration of B1 to MP2RAGE UNI

	cd /Users/z3402744/Work/vci/vci_001/flywheel/dce/nii

	B1map="tfl_b1_map_test/Results/B1Map_for_T1_mapping_20230920144854_110_B1map"
	B1ref="tfl_b1_map_test/Results/B1Map_for_T1_mapping_20230920144854_109_B1ref"
	UNI="t1_mp2rage_sag_0.8x0.8x2_BW240_UNI_Images_20230920144854_107"

	flirt -in $B1ref -ref $UNI -omat B1ref_to_UNI.mat -dof 7 -out B1ref_reg2UNI

	flirt -in $B1map -ref $UNI -applyxfm -init B1ref_to_UNI.mat -out B1map_reg2UNI

	# You can then check coregistration results


Generating T1 map after correcting nominal flip angle using B1 map
------------------------------------------------------------------

Followed instructions in `this page <https://qmrlab.readthedocs.io/en/master/mp2rage_batch.html#>`_. Parameters for protocol are explained in `this page <https://qmrlab.readthedocs.io/en/master/protocols.html#mp2rage>`_.

..  warning::

	Note that the parameters were set according to protocol version 2.1. Check if any parameters have been changed in latest protocol.

..  code-block::

	cd /Users/z3402744/Software/qMRLab-2.4.1
	startup

	% create mp2rage object
	Model = mp2rage;

	% set protocol

	Pre = 22;
	% slices per slab = 88
	% slice partial fourier = 6/8
	% Pre = slices per slab * (slice partial fourier - 0.5)

	Post = 44;
	% Post = slices per slab / 2

	Model.Prot.NumberOfShots.Mat = [ Pre Post ];


	% Inversion (Inv)
	% Can be found as 'TR' under 'Contrast - Common' on PDF protocol
	% This value equals to 5 seconds in VCI.
	% In BIDS, look for 'RepetitionTimePreparation' metadata field.
	% typically 3-6 seconds
	Inv = 5;

	% Excitation (Exc)
	% Can be found as 'Echo Spacing' under 'Sequence - Part 1' on PDF protocol
	% This value equals to 0.00728 second (7.28 ms) in VCI.
	% In BIDS, look for 'RepetitionTimeExcitation' metadatafield.
	% typically 0.006-0.008 seconds
	Exc = 0.00728;

	Model.Prot.RepetitionTimes.Mat = [ Inv  Exc ];


	% Inversion Times
	% Can be found as 'TI 1' and 'TI 2' under 'Contrast - Common' on PDF protocol.
	% These values equal to 700 ms and 2500 ms.
	InversionTimes = [0.7000; 2.5000];

	Model.Prot.Timing.Mat = [ InversionTimes ];


	% Flip Angles
	% Can be found as 'Flip angle 1' and 'Flip angle 2' under 'Contrast - Common' on PDF protocol.
	% These values equal to 4 and 5 degrees.
	FlipAngles = [4.0000; 5.0000];

	Model.Prot.Sequence.Mat = [ FlipAngles ];


	B0 = 3;
	Model.Prot.Hardware.Mat = [ B0 ];

	cd /Users/z3402744/Work/vci/vci_001/flywheel/dce/nii
	MP2RAGE_nii = 't1_mp2rage_sag_0.8x0.8x2_BW240_UNI_Images_20230920144854_107.nii';
	MP2RAGE_nii_dat = niftiread (MP2RAGE_nii);

	B1map_nii = 'B1map_reg2UNI.nii.gz'; % generated by hMRI toolbox, and registered to UNI
	B1ref_nii = 'B1ref_reg2UNI.nii.gz'; % generated by hMRI toolbox, and registered to UNI
	B1map_nii_dat = niftiread(B1map_nii);

	data = struct();
	data.MP2RAGE = double(MP2RAGE_nii_dat);
	data.B1map = double(B1map_nii_dat);

	FitResults = FitData(data,Model,0);

	% You may see the warning of 
	%
	% 	"B1 data is not in [0-2] range. B1map magnitude will be scaled down."
	%
	% This shouldn't be a problem, as long as quality control has been done
	% for B1 map. See the B1 map using hMRI section.

	% To show the output
	% qMRshowOutput(FitResults,data,Model);

	% Save as nii
	FitResultsSave_nii (FitResults, MP2RAGE_nii, '/Users/z3402744/Work/vci/vci_001/flywheel/dce/nii');

	% Save all the options and protocol configurations
	Model.saveObj('/Users/z3402744/Work/vci/vci_001/flywheel/dce/nii/vci_001.qmrlab.mat');


Get ready for processing dynamic data
-------------------------------------

..  code-block::

	cd /Users/z3402744/Work/vci/vci_001/flywheel/dce/nii

	# [OPTIONAL] Merging two dynamic volumes (because the dynamic scan stopped in the middle for VCI_001)
	fslmerge -t dynamic \
				t1_vibe_sag_DCE_2mm_XL_FOV_40s_temporal_res_20230920144854_112.nii \
				t1_vibe_sag_DCE_2mm_XL_FOV_40s_temporal_res_20230920144854_120.nii

	T1uncorr="t1_mp2rage_sag_0.8x0.8x2_BW240_T1_Images_20230920144854_105"
	B1map="tfl_b1_map_test/Results/B1Map_for_T1_mapping_20230920144854_110_B1map"
	B1ref="tfl_b1_map_test/Results/B1Map_for_T1_mapping_20230920144854_109_B1ref"	

	mcflirt -in dynamic

	fslmaths dynamic_mcf -Tmean dynamic_Tmean

	flirt -in MP2RAGEcor -ref dynamic_Tmean -omat MP2RAGE_to_dyn.mat

	flirt -in $T1uncorr -ref dynamic_Tmean -init MP2RAGE_to_dyn.mat -applyxfm -out T1uncorr_reg2dyn
	flirt -in MP2RAGEcor -ref dynamic_Tmean -init MP2RAGE_to_dyn.mat -applyxfm -out MP2RAGEcor_reg2dyn


	convert_xfm  -omat B1ref_to_dyn.mat B1ref_to_UNI.mat -concat MP2RAGE_to_dyn.mat  # Note that mat after -concat is the 2nd mat
	
	flirt -in $B1map -ref dynamic_Tmean -init B1ref_to_dyn.mat -applyxfm -out B1map_reg2dyn
	flirt -in $B1ref -ref dynamic_Tmean -init B1ref_to_dyn.mat -applyxfm -out B1ref_reg2dyn

	optiBET.sh -i dynamic_Tmean.nii.gz

