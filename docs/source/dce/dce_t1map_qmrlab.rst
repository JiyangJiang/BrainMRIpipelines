Generating T1 map with qMRLab
==============================

Reslicing MP2RAGE to 2mm isotropic, and register B1 to MP2RAGE
--------------------------------------------------------------
..  code-block::

	# THIS IS A SHELL SCRIPT

	B1map="/srv/scratch/cheba/Imaging/vci/vci_001/flywheel/dce/nii/reslice_and_coreg/B1Map_for_T1_mapping_20230920144854_110_B1map"
	B1ref="/srv/scratch/cheba/Imaging/vci/vci_001/flywheel/dce/nii/reslice_and_coreg/B1Map_for_T1_mapping_20230920144854_109_B1ref"
	UNI="/srv/scratch/cheba/Imaging/vci/vci_001/flywheel/dce/nii/reslice_and_coreg/t1_mp2rage_sag_0.8x0.8x2_BW240_UNI_Images_20230920144854_107"

	# 1) reslicing MP2RAGE UNI

	echo "1 0 0 0" > eye.mat
	echo "0 1 0 0" >> eye.mat
	echo "0 0 1 0" >> eye.mat
	echo "0 0 0 1" >> eye.mat

	flirt -in $UNI -ref $UNI -init eye.mat -applyisoxfm 2 -out ${UNI}_2mmIso

	# 2) coregistration

	flirt -in $B1ref -ref ${UNI}_2mmIso -omat B1ref_to_UNI.mat -dof 7 -out ${B1ref}_reg2uni

	flirt -in $B1map -ref ${UNI}_2mmIso -applyxfm -init B1ref_to_UNI.mat -out ${B1map}_reg2uni

	# You can then check coregistration results - ${B1ref}_reg2uni and ${B1ref}_reg2uni


Generating T1 map after correcting nominal flip angle using B1 map
------------------------------------------------------------------

Followed instructions in `this page <https://qmrlab.readthedocs.io/en/master/mp2rage_batch.html#>`_. Parameters for protocol are explained in `this page <https://qmrlab.readthedocs.io/en/master/protocols.html#mp2rage>`_.

..  warning::

	Note that the parameters were set according to protocol version 2.1. Check if any parameters have been changed in latest protocol.

..  code-block::

	cd /srv/scratch/cheba/Imaging/software/qMRLab-2.4.2
	startup

	% create mp2rage object
	Model = mp2rage;

	% set protocol

	Pre = 22;
	% slices per slab = 88
	% slice partial fourier = 6/8
	% Pre = slices per slab * (slice partial fourier - 0.5)

	Post = 44;
	% Post = slices per slab / 2

	Model.Prot.NumberOfShots.Mat = [ Pre Post ];


	% Inversion (Inv)
	% Can be found as 'TR' under 'Contrast - Common' on PDF protocol
	% This value equals to 5 seconds in VCI.
	% In BIDS, look for 'RepetitionTimePreparation' metadata field.
	% typically 3-6 seconds
	Inv = 5;

	% Excitation (Exc)
	% Can be found as 'Echo Spacing' under 'Sequence - Part 1' on PDF protocol
	% This value equals to 0.00728 second (7.28 ms) in VCI.
	% In BIDS, look for 'RepetitionTimeExcitation' metadatafield.
	% typically 0.006-0.008 seconds
	Exc = 0.00728;

	Model.Prot.RepetitionTimes.Mat = [ Inv  Exc ];


	% Inversion Times
	% Can be found as 'TI 1' and 'TI 2' under 'Contrast - Common' on PDF protocol.
	% These values equal to 700 ms and 2500 ms.
	InversionTimes = [0.7000; 2.5000];

	Model.Prot.Timing.Mat = [ InversionTimes ];


	% Flip Angles
	% Can be found as 'Flip angle 1' and 'Flip angle 2' under 'Contrast - Common' on PDF protocol.
	% These values equal to 4 and 5 degrees.
	FlipAngles = [4.0000; 5.0000];

	Model.Prot.Sequence.Mat = [ FlipAngles ];


	B0 = 3;
	Model.Prot.Hardware.Mat = [ B0 ];

	MP2RAGE_nii = '/srv/scratch/cheba/Imaging/vci/vci_001/flywheel/dce/nii/reslice_and_coreg/t1_mp2rage_sag_0.8x0.8x2_BW240_UNI_Images_20230920144854_107_2mmIso.nii.gz';
	MP2RAGE_nii_dat = niftiread (MP2RAGE_nii);

	B1map_nii = '/srv/scratch/cheba/Imaging/vci/vci_001/flywheel/dce/nii/reslice_and_coreg/B1Map_for_T1_mapping_20230920144854_110_B1map_reg2uni.nii.gz'; % generated by hMRI toolbox, and registered to UNI
	B1ref_nii = '/srv/scratch/cheba/Imaging/vci/vci_001/flywheel/dce/nii/reslice_and_coreg/B1Map_for_T1_mapping_20230920144854_109_B1ref_reg2uni.nii.gz'; % generated by hMRI toolbox, and registered to UNI
	B1map_nii_dat = niftiread(B1map_nii);

	data = struct();
	data.MP2RAGE = double(MP2RAGE_nii_dat);
	data.B1map = double(B1map_nii_dat);
